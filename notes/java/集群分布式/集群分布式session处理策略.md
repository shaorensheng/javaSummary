文章摘自网上，仅是学习。

## 问题

> 在集群/分布式环境下，需要考虑用户访问产生的session如何处理。</br>
如果不做任何处理，用户将出现频繁登录的现象。</br>
比如：集群中存在A、B两台服务器，用户在第一次访问网站时，，Nginx通过
负载均衡机制将用户请求转发到A服务器，这时A服务器就会给用户创建一个Session。
当用户第二次发请求时，Nginx将其负载均衡到B服务器，而这时候B服务器并不存在Session，
所以就会将用户踢到登录页面。

## 解决

* 粘性session
    * **原理**</br>
        是指将用户锁定到某一个服务器上。</br>
        比如：用户第一次请求时，负载均衡器将用户的请求转发到了A服务器上，
        如果负载均衡设置了粘性Session的话，那么用户以后每次请求都会转发到A服务器上，
        相当于把用户和A服务器粘到了一块，这就是粘性Session机制。
    * **优点**</br>
        简单，不需要对session做任何处理。
    * **缺点**</br>
        缺乏容错性，如果当前访问的服务器发生故障，用户被转移到第二个服务器上时，
        他的session信息都将失效。
    * **适应场景**</br>
        发生故障对客户产生的影响较小；服务器发生故障是低概率事件。
    * **实现方式**</br>
        以Nginx为例，在upstream模块配置ip_hash属性即可实现粘性Session。
        > upstream mycluster{</br>
                &nbsp;&nbsp;&nbsp;ip_hash;#粘性Session </br>
                &nbsp;&nbsp;&nbsp;&nbsp;server A weight=1;</br>
                &nbsp;&nbsp;&nbsp;&nbsp;server B weight=1;</br>
            }


* 服务器session复制
    * **原理**</br>
        任何一个服务器上的sessin发生改变（增删改），该节点会把这个session
        的所有内容序列化，然后广播给所有其它节点，不管其它服务器需不需要session，
        以此来保证Session同步。
    * **优点**</br>
        可容错，各个服务器间session能够实时响应。
    * **缺点**</br>
        会对网络负荷造成一定压力，如果session量大的话可能会造成网络堵塞，
        拖慢服务器性能。
        
        
* session共享机制
    
    使用分布式缓存方案比如memcached、redis，
    但是，要求Memcached或者Redis必须是集群。
    * **原理**</br>
        将session信息放入缓存中。
    * **优点**</br>
        可容错，session实时响应。
    * **缺点**</br>
        redis需要内存较大；需要定期的刷新缓存
    
    
* session持久化到数据库
    * **原理**</br>
        将sessin存入数据库。保证session的持久化。
    * **优点**</br>
        服务器出现问题，session不会丢失。
    * **缺点**</br>
        如果网站的访问量很大，把session存储到数据库中，会对数据库造成很大压力，
        还需要额外的开销维护数据库。
        
        
* terracotta实现session复制
    * **原理**</br>
        Terracotta的基本原理是对与集群间共享的数据，当在一个节点发生变化的时候，
        Terracotta只把变化的部分发送给Terracotta服务器，
        然后有服务器把它转发给真正需要这个数据的节点。
        可以看成是对第二种方案的优化。
    * **优点**</br>
        对网络的压力非常小，各个节点也不必浪费CPU时间和内存进行大量的序列化操作。
        把这种集群间数据共享的机制应用在session同步上，既避免了对数据库的依赖，
        又能达到负载均衡和灾难恢复的效果。
